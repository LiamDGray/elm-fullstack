# 2019-02 SSL Certificate From Letsenrypt

I want to offer HTTPS with Kalmit based web apps.
+ I had used the [ohadschn/letsencrypt-webapp-renewer](https://github.com/ohadschn/letsencrypt-webapp-renewer) to acquire SSL certificates. But now I explore deployment independent of [Azure App Service](./../2018.deploy-to-azure-web-app/2018.deploy-to-azure-web-app.md).
+ Notice [LetsEncrypt ASP .NET Core middleware](https://medium.com/@mathiaslykkegaardlorenzen/letsencrypt-asp-net-core-middleware-a294dcf34d07) by [Mathias Lorenzen](https://github.com/ffMathy). This looks like it could fit well into the Kalmit web host.

## 2019-02-27 Attempt To Integrate FluffySpoon.AspNet.LetsEncrypt

+ Follow the [guide](https://github.com/ffMathy/FluffySpoon.AspNet.LetsEncrypt/blob/master/README.md) to add this to the Kalmit web host implementation.
+ Test this with a configuration for the domain `gridwars.io`:
```putty
docker pull viir/kalmit-test-letsencrypt-02-27
docker run -p 80:80 -p 443:443 viir/kalmit-test-letsencrypt-02-27
```
+ The process crashes, get this logs from the docker container:
```putty
root@kalmit-demo-0-docker:~# docker logs --tail 40 --timestamps --details elastic_dubinsky
2019-02-27T18:05:24.600440725Z  info: FluffySpoon.AspNet.LetsEncrypt.ILetsEncryptChallengeApprovalMiddleware[0]
2019-02-27T18:05:24.600700021Z        => ConnectionId:0HLKSROINBAQJ => RequestId:0HLKSROINBAQJ:00000001 RequestPath:/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:24.600726901Z        The given challenge did not match: /.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:25.112567777Z  info: Microsoft.AspNetCore.Hosting.Internal.WebHost[1]
2019-02-27T18:05:25.112601592Z        => ConnectionId:0HLKSROINBAQL => RequestId:0HLKSROINBAQL:00000001 RequestPath:/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:25.112607105Z        Request starting HTTP/1.1 GET http://gridwars.io/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:25.112611154Z  info: FluffySpoon.AspNet.LetsEncrypt.ILetsEncryptChallengeApprovalMiddleware[0]
2019-02-27T18:05:25.112615499Z        => ConnectionId:0HLKSROINBAQL => RequestId:0HLKSROINBAQL:00000001 RequestPath:/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:25.112619719Z        The given challenge did not match: /.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:25.617282938Z  info: Microsoft.AspNetCore.Hosting.Internal.WebHost[1]
2019-02-27T18:05:25.617330331Z        => ConnectionId:0HLKSROINBAQM => RequestId:0HLKSROINBAQM:00000001 RequestPath:/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:25.617665828Z        Request starting HTTP/1.1 GET http://gridwars.io/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:25.618117808Z  info: FluffySpoon.AspNet.LetsEncrypt.ILetsEncryptChallengeApprovalMiddleware[0]
2019-02-27T18:05:25.618390786Z        => ConnectionId:0HLKSROINBAQM => RequestId:0HLKSROINBAQM:00000001 RequestPath:/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:25.618403935Z        The given challenge did not match: /.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:40.829451912Z  info: Microsoft.AspNetCore.Hosting.Internal.WebHost[2]
2019-02-27T18:05:40.829494943Z        => ConnectionId:0HLKSROINBAQJ => RequestId:0HLKSROINBAQJ:00000001 RequestPath:/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:40.829858167Z        Request finished in 16227.0146ms 200
2019-02-27T18:05:40.830124776Z  info: Microsoft.AspNetCore.Hosting.Internal.WebHost[2]
2019-02-27T18:05:40.830137731Z        => ConnectionId:0HLKSROINBAQK => RequestId:0HLKSROINBAQK:00000001 RequestPath:/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:40.830405335Z        Request finished in 16229.6249ms 200
2019-02-27T18:05:40.830660326Z  info: Microsoft.AspNetCore.Hosting.Internal.WebHost[2]
2019-02-27T18:05:40.830672866Z        => ConnectionId:0HLKSROINBAQM => RequestId:0HLKSROINBAQM:00000001 RequestPath:/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:40.830936751Z        Request finished in 15205.9943ms 200
2019-02-27T18:05:40.831195756Z  info: Microsoft.AspNetCore.Hosting.Internal.WebHost[2]
2019-02-27T18:05:40.831212217Z        => ConnectionId:0HLKSROINBAQL => RequestId:0HLKSROINBAQL:00000001 RequestPath:/.well-known/acme-challenge/APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU
2019-02-27T18:05:40.831486198Z        Request finished in 15711.1199ms 200
2019-02-27T18:05:41.842603353Z
2019-02-27T18:05:41.880426326Z  Unhandled Exception: FluffySpoon.AspNet.LetsEncrypt.Exceptions.OrderInvalidException: One or more LetsEncrypt orders were invalid. Make sure that LetsEncrypt can contact the domain you are trying to request an SSL certificate for, in order to verify it. ---> System.AggregateException: One or more errors occurred. (urn:ietf:params:acme:error:unauthorized: The key authorization file from the server did not match this challenge [APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU.EjoHoJGe7TfaAPUzjdHFCnpRfjLk_HA0xYhiXwAlokY] != []) ---> System.Exception: urn:ietf:params:acme:error:unauthorized: The key authorization file from the server did not match this challenge [APEwp8pWY1_Ck0173yDShDk9c0NQFQdh35oPaC7-LsU.EjoHoJGe7TfaAPUzjdHFCnpRfjLk_HA0xYhiXwAlokY] != []
2019-02-27T18:05:41.880468188Z     --- End of inner exception stack trace ---
2019-02-27T18:05:41.880473011Z     --- End of inner exception stack trace ---
2019-02-27T18:05:41.880476811Z     at FluffySpoon.AspNet.LetsEncrypt.LetsEncryptRenewalService.ValidateOrderAsync(IOrderContext order)
2019-02-27T18:05:41.880480873Z     at FluffySpoon.AspNet.LetsEncrypt.LetsEncryptRenewalService.ValidateOrderAsync(IOrderContext order)
2019-02-27T18:05:41.880484786Z     at FluffySpoon.AspNet.LetsEncrypt.LetsEncryptRenewalService.AcquireNewCertificateForDomains(String[] domains)
2019-02-27T18:05:41.880488791Z     at FluffySpoon.AspNet.LetsEncrypt.LetsEncryptRenewalService.RunOnceAsync()
2019-02-27T18:05:41.880492573Z     at FluffySpoon.AspNet.LetsEncrypt.LetsEncryptRenewalService.RunOnceAsync()
2019-02-27T18:05:41.880496230Z     at FluffySpoon.AspNet.LetsEncrypt.LetsEncryptRenewalService.<StartAsync>b__16_0(Object state)
2019-02-27T18:05:41.880500535Z     at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
2019-02-27T18:05:41.880504428Z  --- End of stack trace from previous location where exception was thrown ---
2019-02-27T18:05:41.880877898Z     at System.Threading.ThreadPoolWorkQueue.Dispatch()
```
